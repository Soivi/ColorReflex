<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf-8">
<title>Color Reflex</title>
<link href="style.css" rel="stylesheet" type="text/css">
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="js/finalColorListCreator.js"></script>
<script>
$(function () {
		$('#infoBar').hide();
		$('#highScoresBar').hide();
		var infobarhidden = true;
		var highscorebarhidden = true;
		var timeLeft = 360;
		var gameTime = 0;
		var yourRecordHard = 0;
		var yourRecordMedium = 0;
		var yourRecordEasy = 0;
		var hard = 3.5;
		var medium = 2.5;
		var easy = 1.5;
		var difficulty = easy;
		var rightAnswers = 0;
		var totalAnswers = 2;
		var colorList = finalColorList.slice();
		var gameOn = false;
		$('#rightPoints').text(rightAnswers + '/' + totalAnswers);
		$('#gameTimeText').text(gameTime);
		$('#yourRecordText').text(yourRecordEasy);
		var timeBarInterval;
		var plname = "";
		
		// Random first Quess
		for (i = colorList.length; i > 9; i--) {
			var number = Math.floor(Math.random() * colorList.length);
			colorList.splice(number, 1);
		}
		var wantedColorIndex = Math.floor(Math.random() * colorList.length)
		var rightAnswer = colorList[wantedColorIndex].rgb;
		$('#wantedColor').text(colorList[wantedColorIndex].color);
		$('#wantedColor').css('color', colorList[Math.floor(Math.random() * colorList.length)].color);
		
		// Create table
        var table = $('<table></table>').addClass('gameTable');
		for (j = 0; j < 3; j++) {
					row = $('<tr></tr>');
					for (i = 0; i < 3; i++) {
						var number = Math.floor(Math.random() * colorList.length);
						var row1 = $('<td></td>').addClass('bar');
						var button = $('<button></button>').css('background-color', colorList[number].color);
						button.disabled = true;
						button.addClass('colorButton');
						button.attr('id', j + '' + i );
						colorList.splice(number, 1);
						table.append(row);
						row.append(row1);
						row1.append(button);
					}

			if ($('.gameTable').length) {
				 $(".gameTable tr:first").after(row);
			}
			else {
				$('#gameArea').append(table);
			}
		}
		// Disable buttons because game isn't on
		$('.colorButton').attr("disabled", true);
		
		// Check if quess is right.
		$('.colorButton').on('click', function() {
			if($(this).css("background-color") == rightAnswer) {
				rightAnswers++;
				if(rightAnswers >= totalAnswers) {
					gameFinished();
				}
			} else {
				gameTime = gameTime + 5;
			}
			newQuestion();
		});
			
		// Create new quess and update gameAreaButtons
		function newQuestion() {
			timeLeft = 360;
						
		$('#rightPoints').text(rightAnswers + '/' + totalAnswers);

			colorList = finalColorList.slice();
			for (i = colorList.length; i > 9; i--) {
				var number = Math.floor(Math.random() * colorList.length);
				colorList.splice(number, 1);
			}
			
			wantedColorIndex = Math.floor(Math.random() * colorList.length)
			rightAnswer = colorList[wantedColorIndex].rgb;
			$('#wantedColor').text(colorList[wantedColorIndex].color);
			$('#wantedColor').css('color', colorList[Math.floor(Math.random() * colorList.length)].color);
			
			for (j = 0; j < 3; j++) {
						for (i = 0; i < 3; i++) {
							var number = Math.floor(Math.random() * colorList.length);
							var colorButtonIDtemp = j + '' + i ;
							$('#'+colorButtonIDtemp).css('background-color', colorList[number].color);
							colorList.splice(number, 1);
						}
			}
		};
		
		// Start and stop function
		$('#startStopButton').on('click', function() {
			if(gameOn) {
				stopGame();
				gameOn = false;
			} else {
				startGame();
				gameOn = true;
			}
		});
		
		// Game is starting function. Reset variables to new game
		function startGame() {
			$('.difficultyLevel').attr("disabled", "disabled");
			$('.naviSecondRow').attr("disabled", "disabled");
			// how long take to start game
			var time = 5;
			rightAnswers = 0;
			gameTime = 0;
			var interval = window.setInterval(function(){
				$('#startStopButton').text('Starting ' + time);
				if(time == 0) {
					clearInterval(interval);
					$('#startStopButton').text('Stop');
					newQuestion();
					$('.colorButton').attr("disabled", false);
					gameIsOn();
					$('.difficultyLevel').removeAttr("disabled");
					$('.naviSecondRow').removeAttr("disabled");
				}
				time--;
			}, 1000);
		}
		
		// When game is on. Add more gametime and take time off from timebar
		function gameIsOn() {
			timeBarInterval = window.setInterval(function(){
				gameTime = gameTime + 0.01;
				$('#gameTimeText').text(gameTime.toFixed(2));
				timeLeft = timeLeft - difficulty;
				$('#timeBarLeft').css('width', timeLeft);
				if (timeLeft <= 0) {
					gameTime = gameTime + 5;
					newQuestion()
				} else if (timeLeft < 100) {
					$('#timeBarLeft').css('background-color', 'red');
				} else if (timeLeft < 200) {
					$('#timeBarLeft').css('background-color', 'yellow');
				} else {
					$('#timeBarLeft').css('background-color', 'rgb(120,240,30)');
				}
			}, 10);
		}
		
		// Stops game. Stops timebar and gametime.
		function stopGame() {
			$('#startStopButton').text('Start');
			clearInterval(timeBarInterval);
			$('.colorButton').attr("disabled", true);
			gameOn = false;
		}
		
		// When game is over send highscores to database if you play difficulty hard and save highscore records.
		function gameFinished() {
			stopGame();

			if(difficulty == hard && (gameTime < yourRecordHard || yourRecordHard == 0)) {
				yourRecordHard = gameTime.toFixed(2);
				$('#yourRecordText').text(yourRecordHard);
				
				if (!plname) {
					plname=prompt("Please enter your name to highscores", "");
				}
				
				if (plname) {
					plname = plname.substr( 0, 25 );
					$.getJSON('http://colorreflex.soivi.net/highscores.php?callback=?',{highscorelist:'Insert', name:plname, time:yourRecordHard});
				}

			} else if (difficulty == medium && (gameTime < yourRecordMedium || yourRecordMedium == 0)) {
				yourRecordMedium = gameTime.toFixed(2);
				$('#yourRecordText').text(yourRecordMedium);
			} else if (difficulty == easy && (gameTime < yourRecordEasy || yourRecordEasy == 0)) {
				yourRecordEasy = gameTime.toFixed(2);
				$('#yourRecordText').text(yourRecordEasy);
			}
		}
		
		// Changes difficulty level
		$('.difficultyLevel').click(function(){
			document.getElementById("easy").className = "difficultyLevel";
			document.getElementById("medium").className = "difficultyLevel";
			document.getElementById("hard").className = "difficultyLevel";
			
			document.getElementById(this.id).className = "difficultyLevel activeDifficulty";
			
			stopGame();
			if(this.id == "hard") {
				$('#yourRecordText').text(yourRecordHard);
				difficulty = hard;
			} else if (this.id == "medium") {
				$('#yourRecordText').text(yourRecordMedium);
				difficulty = medium;
			} else {
				$('#yourRecordText').text(yourRecordEasy);
				difficulty = easy;
			}
		});
		
		// Infobar is visible or hidden.
		$('#info').on('click', function() {
			if(infobarhidden) {
				document.getElementById(this.id).className = "naviSecondRow activeDifficulty";
				infobarhidden = false;
			} else {
				document.getElementById(this.id).className = "naviSecondRow";
				infobarhidden = true;
			}
			$('#infoBar').fadeToggle(1500);
		});
		
		// Highscores are visible or hidden. When Highscores comes to visible reset highscores and get newest highscores from database.
		$('#highscores').on('click', function() {
			if(highscorebarhidden) {
				$('#highScoreTable tr.highscoreRow').remove();
				
				$.getJSON('http://colorreflex.soivi.net/highscores.php?callback=?','highscorelist=All',function(res){
					var forLoopSize = 9;
					if (res.length <= forLoopSize) {
						forLoopSize = res.length - 1; 
					}
					for (j = forLoopSize; j >= 0; j--) {
							row = $('<tr></tr>').addClass('highscoreRow');
							var place = $('<td></td>').text(j+1);
							var name = $('<td></td>').text(res[j].name);
							var time = $('<td></td>').text(res[j].time);
							$("#highScoreTable").append(row);
							row.append(place);
							row.append(name);
							row.append(time);
						 $("#highScoreTable tr:first").after(row);
				}
				});
				document.getElementById(this.id).className = "naviSecondRow activeDifficulty";
				highscorebarhidden = false;
			} else {
				document.getElementById(this.id).className = "naviSecondRow";
				highscorebarhidden = true;
			}
			$('#highScoresBar').fadeToggle(1500);
		});
});
</script>
</head>
<body>
<div id="wholeGameArea">
<div id="navBarDiv">
<ul id="difficultyLevelNav">
<li><a class="difficultyLevel activeDifficulty" id="easy">Easy</a></li>
<li><a class="difficultyLevel" id="medium">Medium</a></li>
<li><a class="difficultyLevel" id="hard">Hard</a></li>
</ul>
<ul id="naviSecondRowNav">
<li><a class="naviSecondRow" id="info">Info</a></li>
<li><a class="naviSecondRow" id="highscores">High scores</a></li>
<li><a class="naviSecondRow" id="startStopButton">Start</a></li>
</ul>
</div>
<div id="infoBar" class="hiddenBars">
<div id="infoBarText">
<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Maecenas pellentesque aliquet arcu eu molestie.
 Nullam iaculis, lacus non convallis ultrices, ante lacus ultricies tortor, sed laoreet nisi lorem et dui.
 Curabitur facilisis odio at velit consequat, non dictum lorem dignissim. Nulla facilisi. Fusce pellentesque velit ac nibh ultrices,
 varius tincidunt nulla congue. Integer porttitor viverra elit, id blandit risus tempor nec. Sed ut ornare odio. Proin ullamcorper nisl massa,
 feugiat fringilla nulla faucibus id. Nullam ac dui vel justo mattis dignissim eu eget justo. Mauris convallis pellentesque turpis, vulputate 
 vestibulum erat scelerisque quis. </p>
</div>
</div>

<div id="highScoresBar" class="hiddenBars">
<table id="highScoreTable">
<tr>
<th>Place</th>
<th>Name</th>
<th>Time (hard)</th>
</tr>
</table>
</div>

<table id="statisticsTable">
<tr>
<td>Points</td>
<td>Time</td>
<td>Your record</td>
</tr>
<tr>
<td id="rightPoints"></td>
<td id="gameTimeText"></td>
<td id="yourRecordText"></td>
</tr>
</table>

<h1 id="wantedColor"></h1>
<div id="timeBar"><div id="timeBarLeft"></div></div>
<div id="gameArea"></div>
</div>
</body>
</html>
